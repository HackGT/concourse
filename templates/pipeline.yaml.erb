resource_types:
<% if pipeline[:charts].length > 0 %>
- name: helm-resource
  type: docker-image
  source:
    repository: hackgt/helm-resource
<% end %>

<% if pipeline[:runnables].length > 0 %>
- name: k8s-resource
  type: docker-image
  source:
    repository: frodenas/k8s-resource
<% end %>


resources:
<% if pipeline[:charts].length > 0 %>
- name: helm
  type: helm-resource
  source:
    url: "{{k8s_url}}"
    ca_data: "{{k8s_ca_data}}"
    username: "{{k8s_user}}"
    password: "{{k8s_pass}}"
    namespace: default

- name: helm-charts
  type: git
  source:
    uri: <%= pipeline[:git_remote] %>
    branch: master
    version:
      ref: <%= pipeline[:git_ref] %>
    paths:
      - <%= pipeline[:git_path] %>
<% end %>

<% if pipeline[:runnables].length > 0 %>
- name: concourse-config
  type: git
  source:
    uri: https://github.com/hackgt/concourse.git
    branch: master

- name: hackgt-cluster
  type: k8s-resource
  source:
    url: "{{k8s_url}}"
    skip_tls_verify: true
    username: "{{k8s_user}}"
    password: "{{k8s_pass}}"
    namespace: default
<% end %>

jobs:
<% if pipeline[:runnables].length > 0 %>
- name: deploy
  public: true
  plan:
  <% if pipeline[:charts].length > 0 %>
  - aggregate:
    - get: helm-charts
      trigger: true
    - get: helm
      trigger: true
  - put: helm
    params:
      charts:
      <% for chart in pipeline[:charts] %>
        <%= chart['name'] %>:
          name: <%= chart['helm'] %>
          <% if chart.include? 'version' %>
          version: <%= chart['version'] %>
          <% end %>
      <% end %>
  <% end %>
  - aggregate:
    <% for app in pipeline[:runnables] %>
    - get: <%= app['name'] %>
      trigger: true
      passed: [build-<%= app['name'] %>-image]
    <% end %>
    - get: concourse-config
      trigger: true
  - task: build-k8s-config
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: frolvlad/alpine-ruby
      inputs:
      - name: helm-charts
      - name: concourse-config
      <% for app in pipeline[:runnables] %>
      - name: <%= app['name'] %>
      <% end %>
      outputs:
      - name: built-config
      params:
        BIODOME_FILE: helm-charts/<%= pipeline[:git_path] %>
        OUTPUT_FILE: built-config/deployment.yaml
      run:
        path: ruby
        args:
          - concourse-config/tasks/gen-k8s.rb
  - put: hackgt-cluster
    params:
      spec_path: built-config/deployment.yaml
<% end %>
