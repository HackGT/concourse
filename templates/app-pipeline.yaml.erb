resources:
<% if app.include? 'git' %>
- name: <%= app['name'] %>
  type: git
  source:
    uri: <%= app['git'] %>
    branch: <%= app['branch'].nil? ? 'master' : app['branch'] %>

- name: <%= app['name'] %>-image
  type: docker-image
  source:
    repository: <%= git_to_shortname(app['git']).downcase %>
    email: "{{dockerhub_email}}"
    username: "{{dockerhub_user}}"
    password: "{{dockerhub_pass}}"
<% end %>

jobs:
<% if app.include? 'git' %>
- name: build-<%= app['name'] %>-image
  public: true
  plan:
  - get: <%= app['name'] %>
    trigger: true
  - try:
      task: build-<%= app['name'] %>
      file: <%= app['name'] %>/build.yaml
  - try:
      task: move-build-output
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: busybox
        inputs:
        - name: build-output
        outputs:
        - name: <%= app['name'] %>
        run:
          path: cp
          args:
            - -a
            - build-output/
            - <%= app['name'] %>/
  - put: <%= app['name'] %>-image
    params:
      build: <%= app['name'] %>
    get_params:
      skip_download: true
<% end %>
