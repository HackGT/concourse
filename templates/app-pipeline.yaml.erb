resource_types:
- name: k8s-resource
  type: docker-image
  source:
    repository: frodenas/k8s-resource

<% if app.include? 'helm' %>
- name: helm-resource
  type: docker-image
  source:
    repository: hackgt/helm-resource
<% end %>

resources:
<% if app.include? 'git' %>
- name: <%= app['name'] %>
  type: git
  source:
    uri: <%= app['git'] %>
    branch: <%= app['branch'].nil? ? 'master' : app['branch'] %>

- name: <%= app['name'] %>-image
  type: docker-image
  source:
    repository: <%= git_to_shortname app['git'] %>
    email: "{{dockerhub_email}}"
    username: "{{dockerhub_user}}"
    password: "{{dockerhub_pass}}"

  <% if app.include? 'run' %>
- name: hackgt-cluster
  type: k8s-resource
  source:
    url: "{{k8s_url}}"
    skip_tls_verify: true
    username: "{{k8s_user}}"
    password: "{{k8s_pass}}"
    namespace: default
  <% end %>
<% end %>

<% if app.include? 'helm' %>
- name: helm
  type: helm-resource
  source:
    url: "{{k8s_url}}"
    ca_data: "{{k8s_ca_data}}"
    username: "{{k8s_user}}"
    password: "{{k8s_pass}}"
    namespace: default

- name: pipeline-updates
  type: git
  source:
    uri: <%= pipeline[:git_remote] %>
    branch: master
    version:
      ref: <%= pipeline[:git_ref] %>
    paths:
      - <%= pipeline[:git_path] %>
<% end %>

jobs:
<% if app.include? 'git' %>
- name: build-<%= app['name'] %>-image
  plan:
  - get: <%= app['name'] %>
    trigger: true
  - put: <%= app['name'] %>-image
    params:
      build: <%= app['name'] %>
    get_params:
      skip_download: true
  <% if app.include? 'run' %>
  - put: hackgt-cluster
    params:
      spec_path: <%= app['name'] %>/deployment.yml
  <% end %>
<% elsif app.include? 'helm' %>
- name: install-<%= app['name'] %>
  plan:
  - get: pipeline-updates
    trigger: true
  - get: helm
    trigger: true
  - put: helm
    params:
      charts:
        <%= app['name'] %>:
          name: <%= app['helm'] %>
          <% if app.include? 'version' %>
          version: <%= app['version'] %>
          <% end %>
<% end %>
